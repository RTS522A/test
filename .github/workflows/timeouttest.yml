name: timeouts
on:
  workflow_dispatch:

jobs:
  test:
      runs-on: windows-latest
      steps:
      - uses: actions/checkout@v2
      - name: Build
        run: |
          $MyScript = {
              Start-Sleep -s 10000
          }

          $JobGUID = [system.Guid]::NewGuid()

          $elapsedEventHandler = {
            param ([System.Object]$sender, [System.Timers.ElapsedEventArgs]$e)
            ($sender -as [System.Timers.Timer]).Stop()
            Unregister-Event -SourceIdentifier $JobGUID
            Write-Host "Job $JobGUID removed by force as it exceeded timeout!"
            Get-Job -Name $JobGUID | Remove-Job -Force
          }

          $timer = New-Object System.Timers.Timer -ArgumentList 3000 #just change the timeout here
          Register-ObjectEvent -InputObject $timer -EventName Elapsed -Action $elapsedEventHandler -SourceIdentifier $JobGUID
          $timer.Start()

          $job = Start-Job -ScriptBlock $MyScript -Name $JobGUID

          while ($true) {
            Write-Host $job.JobStateInfo.State
	          if ($result = $job | Receive-Job )
            {
	            Write-Host $result
	          }
	          if('Running' -ne $job.JobStateInfo.State) {
              Write-Host "JOB DONE"
              break
            }
	          Start-Sleep -Milliseconds 500
	
          }
